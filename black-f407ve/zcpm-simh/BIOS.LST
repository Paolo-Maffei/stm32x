Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    Z80

    1                   ; Minimal CPM 2.2 BIOS -jcw, 2018-11-10
    2                   
    3         0001      VERS:   equ 01h
    4                   
    5                   ; Memory map -------------------------------------------------------------------
    6                   
    7         E800      CCP:    equ 0E800h
    8         F006      BDOS:   equ CCP + 0806h
    9         FE00      BIOS:   equ CCP + 1600h
   10         FFFE      BEND:   equ CCP + 17FEh
   11                   
   12                   ; low memory -------------------------------------------------------------------
   13                   
   14         0003      iobyte: equ 03h     ; Intel standard I/O definition byte
   15         0004      usrdrv: equ 04h     ; Current user number and drive
   16         0080      tpabuf: equ 0080h   ; Default I/O buffer and command line storage
   17                   
   18         FE00               org BIOS
   19                   
   20                   ; BIOS jump table --------------------------------------------------------------
   21                   
   22 FE00  C3 FE72     	jp boot     ;  0 Initialize
   23 FE03  C3 FE84     wboote: jp wboot    ;  1 Warm boot
   24 FE06  C3 FEB4     	jp conist   ;  2 Console status
   25 FE09  C3 FEB7     	jp conin    ;  3 Console input
   26 FE0C  C3 FEBA     	jp conout   ;  4 Console OUTput
   27 FE0F  C3 FF08     	jp list     ;  5 List OUTput
   28 FE12  C3 FF08     	jp punch    ;  6 punch OUTput
   29 FE15  C3 FEBD     	jp reader   ;  7 Reader input
   30 FE18  C3 FEE1     	jp home     ;  8 Home disk
   31 FE1B  C3 FEC0     	jp seldsk   ;  9 Select disk
   32 FE1E  C3 FEE3     	jp settrk   ; 10 Select track
   33 FE21  C3 FEE8     	jp setsec   ; 11 Select sector
   34 FE24  C3 FEED     	jp setdma   ; 12 Set DMA ADDress
   35 FE27  C3 FEF5     	jp read     ; 13 Read 128 bytes
   36 FE2A  C3 FEF9     	jp write    ; 14 Write 128 bytes
   37 FE2D  C3 FF08     	jp listst   ; 15 List status
   38 FE30  C3 FEF2     	jp sectrn   ; 16 Sector translate
   39                   
   40                   ; Disk Parameter Headers -------------------------------------------------------
   41                   
   42 FE33  0000  0000  dpbase:	dw 0,0,0,0,dirbuf,dpb,0,alv0
   43 FE43  0000  0000  	dw 0,0,0,0,dirbuf,dpb,0,alv1
   44 FE53  0000  0000  	dw 0,0,0,0,dirbuf,dpb,0,alv2
   45                   
   46 FE63  001A        dpb:	dw 26  ; SPT - sectors per track
   47 FE65  03          	db 3   ; BSH - block shift factor
   48 FE66  07          	db 7   ; BLM - block mask
   49 FE67  00          	db 0   ; EXM - Extent mask
   50 FE68  00F2        	dw 242 ; DSM - Storage size (blocks - 1)
   51 FE6A  003F        	dw 63  ; DRM - Number of directory entries - 1
   52 FE6C  C0          	db 192 ; AL0 - 1 bit set per directory block
   53 FE6D  00          	db 0   ; AL1 - ... 8 more bits
   54 FE6E  0000        	dw 0   ; CKS - DIR check vector size (DRM+1)/4 (0=fixed disk)
   55 FE70  0002        	dw 2   ; OFF - Reserved tracks
   56                   
   57                   ; Cold boot --------------------------------------------------------------------
   58                   
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    Z80

   59 FE72  F3          boot:	di
   60 FE73  31 0100     	ld sp,0100h
   61                   
   62 FE76  11 FF0A             ld de,dirbuf
   63 FE79  DB 03               in a,(3)                ; display greeting
   64                   
   65 FE7B  AF          	xor a
   66 FE7C  32 0003     	ld (iobyte),a
   67 FE7F  32 0004     	ld (usrdrv),a
   68 FE82  18 0F       	jr gocpm
   69                   
   70                   ; Warm boot --------------------------------------------------------------------
   71                   
   72 FE84  F3          wboot:	di
   73 FE85  31 0100     	ld sp,0100h
   74                   
   75 FE88  AF          	xor a
   76 FE89  06 2C               ld b,44                 ; read CCP + BDOS into memory
   77 FE8B  11 0001             ld de,1                 ; skip first sector on first track
   78 FE8E  21 E800             ld hl,CCP               ; start address
   79 FE91  DB 04       	in a,(4)                ; disk read request
   80                   
   81                   ; Common code for cold and warm boot
   82                   
   83 FE93  21 0080     gocpm:	ld hl,tpabuf            ; Address of BIOS DMA buffer
   84 FE96  22 FF8D     	ld (dmaadr),hl
   85 FE99  3E C3       	ld a,0C3h               ; Opcode for 'JP'
   86 FE9B  32 0000     	ld (00h),a              ; Load at start of RAM
   87 FE9E  21 FE03     	ld hl,wboote            ; Address of jump for a warm boot
   88 FEA1  22 0001     	ld (01h),hl
   89 FEA4  32 0005     	ld (05h),a              ; Opcode for 'JP'
   90 FEA7  21 F006     	ld hl,BDOS              ; Address of jump for the BDOS
   91 FEAA  22 0006     	ld (06h),hl
   92 FEAD  3A 0004     	ld a,(usrdrv)           ; Save new drive number (0)
   93 FEB0  4F          	ld c,a                  ; Pass drive number in C
   94 FEB1  C3 E800     	jp CCP                  ; Start CP/M by jumping to the CCP
   95                   
   96                   ; Console I/O ------------------------------------------------------------------
   97                   
   98 FEB4  DB 00       conist:	in a,(0)
   99 FEB6  C9          	ret
  100                   
  101 FEB7  DB 01       conin:	in a,(1)
  102 FEB9  C9          	ret
  103                   
  104 FEBA  DB 02       conout:	in a,(2)
  105 FEBC  C9          	ret
  106                   
  107 FEBD  3E 1A       reader:	ld a,1Ah
  108 FEBF  C9          	ret
  109                   
  110                   ; Disk I/O ---------------------------------------------------------------------
  111                   
  112 FEC0  79          seldsk: ld a,c
  113 FEC1  FE 03       	cp 3
  114 FEC3  30 0F               jr nc,baddsk
  115 FEC5  26 00               ld h,0
  116 FEC7  69                  ld l,c
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    Z80

  117 FEC8  29                  add hl,hl
  118 FEC9  29                  add hl,hl
  119 FECA  29                  add hl,hl
  120 FECB  29                  add hl,hl
  121 FECC  11 FE33             ld de,dpbase
  122 FECF  19                  add hl,de
  123 FED0  32 FF8A     savdsk:	ld (sekdsk),a
  124 FED3  C9                  ret
  125                   
  126 FED4  21 0000     baddsk: ld hl,0
  127 FED7  3A 0004             ld a,(usrdrv)
  128 FEDA  91                  sub a,c
  129 FEDB  C0                  ret nz
  130 FEDC  32 0004             ld (usrdrv),a
  131 FEDF  18 EF               jr savdsk
  132                   
  133 FEE1  0E 00       home:	ld c,0
  134 FEE3  79          settrk: ld a,c
  135 FEE4  32 FF8C     	ld (seksat+1),a
  136 FEE7  C9                  ret
  137                   
  138 FEE8  21 FF8B     setsec: ld hl,seksat
  139 FEEB  71                  ld (hl),c
  140 FEEC  C9                  ret
  141                   
  142 FEED  ED 43 FF8D  setdma: ld (dmaadr),bc
  143 FEF1  C9                  ret
  144                   
  145 FEF2  69          sectrn: ld l,c
  146 FEF3  60          	ld h,b
  147 FEF4  C9                  ret
  148                   
  149 FEF5  06 01       read:	ld b,1
  150 FEF7  18 02               jr rdwr
  151 FEF9  06 81       write:	ld b,1+128
  152 FEFB  3A FF8A     rdwr:   ld a,(sekdsk)
  153 FEFE  ED 5B FF8B          ld de,(seksat)
  154 FF02  2A FF8D             ld hl,(dmaadr)
  155 FF05  DB 04               in a,(4)
  156 FF07  C9          	ret
  157                   
  158 FF08              listst:
  159 FF08              list:
  160 FF08              punch:
  161 FF08  AF          	xor a
  162 FF09  C9          	ret
  163                   
  164                   ; Data area --------------------------------------------------------------------
  165                   
  166 FF0A  36 34 6B 20 dirbuf: db '64k CP/M vers 2.2',13,10,0
  167 FF1E    006C              ds dirbuf+128-$ ; scratch directory area
  168                   
  169 FF8A    0001      sekdsk: ds 1   ; seek disk number
  170 FF8B    0002      seksat: ds 2   ; seek sector and track number
  171 FF8D    0002      dmaadr: ds 2   ; last dma address
  172                   
  173 FF8F    0020      alv0:   ds 32  ; allocation vector 0 (max 255 blocks)
  174 FFAF    0020      alv1:   ds 32  ; allocation vector 1 (max 255 blocks)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    Z80

  175 FFCF    0020      alv2:   ds 32  ; allocation vector 2 (max 255 blocks)
  176                   
  177         000F      spare:  equ BEND-$
  178 FFEF    000F              ds spare                ; BIOS base page and version number
  179 FFFE  FE01                dw BIOS + VERS          ; ... at end of memory
  180                   
  181                   ; ------------------------------------------------------------------------------
  182                   
  183                           end
 0 Error(s) Detected.
 40 Symbols Detected.
----------------------------------------------------------------------------
  187                   
  188                           end
 0 Error(s) Detected.
 39 Symbols Detected.
s Detected.
Detected.

